<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Reset Password - Daren Prince</title>
  <link href="https://fonts.googleapis.com/css2?family=League+Spartan:wght@700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="assets/styles.css">
  <link rel="stylesheet" href="https://unpkg.com/@tabler/icons-webfont@latest/dist/tabler-icons.min.css">
</head>
<body class="theme-dark">
  <main>
    <div class="container--spaced max-width-adaptive-lg">
      <section class="reset-container">
        <form id="reset-form" class="card spacing-y-sm">
          <h1 class="text-center margin-bottom-md">Reset Password</h1>
          <div class="form-group">
            <label for="password">New Password</label>
            <input type="password" id="password">
          </div>
          <div class="form-group">
            <label for="confirm-password">Confirm Password</label>
            <input type="password" id="confirm-password">
          </div>
          <div class="password-strength">
            <ul class="password-reqs">
              <li data-req="length"><i class="ti ti-circle"></i> 8+ characters</li>
              <li data-req="upper"><i class="ti ti-circle"></i> Uppercase letter</li>
              <li data-req="lower"><i class="ti ti-circle"></i> Lowercase letter</li>
              <li data-req="number"><i class="ti ti-circle"></i> Number</li>
              <li data-req="symbol"><i class="ti ti-circle"></i> Symbol</li>
              <li data-req="match"><i class="ti ti-circle"></i> Passwords match</li>
            </ul>
          </div>
          <p class="status-message"></p>
          <button type="submit" class="btn btn--primary full-width js-submit" disabled>Update Password</button>
          <p class="text-center margin-top-sm"><a href="login.html">Return to login</a></p>
        </form>
      </section>
    </div>
  </main>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <script type="module">
    import { initPasswordStrength, passwordsValid, resetPasswordStrength } from './js/password-strength.js';
    import supabaseClient from '../supabase/client.js';
    const form = document.getElementById('reset-form');
    const messageEl = document.querySelector('.status-message');
    const submitBtn = document.querySelector('.js-submit');
    document.addEventListener('DOMContentLoaded', async () => {
      initPasswordStrength(submitBtn);
      resetPasswordStrength(submitBtn);
      const params = new URLSearchParams(window.location.hash.slice(1));
      const access_token = params.get('access_token');
      const refresh_token = params.get('refresh_token');
      if (access_token && refresh_token) {
        const { error } = await supabaseClient.auth.setSession({ access_token, refresh_token });
        if (error) {
          messageEl.textContent = `Failed to process password reset link: ${error.message}. Please try requesting a new link.`;
          submitBtn.disabled = true;
          document.getElementById('password').disabled = true;
          document.getElementById('confirm-password').disabled = true;
        }
      }
    });
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      if (!passwordsValid()) {
        messageEl.textContent = 'Please meet password requirements.';
        return;
      }
      const password = document.getElementById('password').value;
      const { error } = await supabaseClient.auth.updateUser({ password });
      messageEl.textContent = error ? error.message : 'Password updated. You may now sign in.';
    });
  </script>
  <script type="module" src="./js/seo-indexing.js"></script>
</body>
</html>
