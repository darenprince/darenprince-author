# üîê Supabase Control Playbook

_Last updated: 2025-02-15_

---

## ‚ö° Status snapshot

- **Tests:** `npm test` now covers the deployment orchestrator alongside env resolution, auth, storage, and Netlify routing.
- **Automation:** `npm run deploy:supabase -- --dry-run` plans `supabase db push` plus function deploys (`secure-storage`, `admin-users`). Use `npm run deploy:auto` to chain build ‚Üí Supabase deploy ‚Üí Netlify deploy when credentials are present.
- **Admin access:** Seed user staged for QA ‚Äî see [Section 7](#7-bootstrap-an-admin-account) for credentials and reminders.

## üéØ Next actions

1. Install the Supabase CLI (`npm install -g supabase`) and authenticate via `supabase login` before running `npm run deploy:supabase`.
2. Provide `SUPABASE_PROJECT_REF` in CI to unlock non-interactive function deploys.
3. Rotate the dummy admin password after first sign-in; promote additional admins with `scripts/bootstrap-admin.js`.
4. Run `scripts/bootstrap-admin.js` after seeding credentials to elevate accounts ‚Äî the utility now targets `public.profiles.user_id`, matching the latest schema.
5. `npm run deploy:supabase` provisions Supabase secrets automatically; ensure `SUPABASE_DATABASE_URL` and `SUPABASE_SERVICE_ROLE_KEY` exist in the environment so edge functions can boot.

This playbook expands on the quick reference with schema details, access model, and operational steps. It assumes credentials are supplied via environment variables (no project IDs are hard-coded).

---

## 1. Runtime configuration

`supabase/env.js` resolves credentials in this order:

1. `Deno.env` (edge functions)
2. `process.env` (Node scripts/tests)
3. Browser runtime overrides:
   - `localStorage.supabaseRuntimeConfig` (set from the login configurator)
   - `window._env_` (e.g. injected by QA tooling)
4. `assets/js/env.js` (generated by `scripts/generate-env.js`)

Set the following keys locally, in Netlify, and for CLI automation:

```bash
SUPABASE_DATABASE_URL=https://<project>.supabase.co
SUPABASE_ANON_KEY=<anon>
SUPABASE_SERVICE_ROLE_KEY=<service-role>
SUPABASE_JWT_SECRET=<jwt-secret>
```

Aliases (`SUPABASE_URL`, `NEXT_PUBLIC_SUPABASE_URL`, `NEXT_PUBLIC_SUPABASE_ANON_KEY`, `PUBLIC_SUPABASE_URL`, `PUBLIC_SUPABASE_ANON_KEY`, `PUBLIC_SUPABASE_PUBLISHABLE_KEY`) are supported. Run `npm run build` whenever credentials change so `assets/js/env.js` stays in sync.

### Browser overrides for QA

- The **login page** exposes a floating ‚ÄúSupabase config‚Äù panel (`js/supabase-runtime-config.js`). Drop in a project URL, anon key, and optional JWT secret to refresh the client instantly‚Äîno rebuild required.
- Overrides persist in `localStorage.supabaseRuntimeConfig`. Clear them from the panel to return to the bundled credentials.
- Runtime updates dispatch `supabase-runtime-config:update`, allowing `supabase/client.js` to rebuild the shared client for all modules listening via `getSupabase()`.

---

## 2. Database & policy snapshot

### `public.profiles`

- Columns: `user_id` (FK to `auth.users`), `first_name`, `last_name`, `phone`, `shipping_address`, `avatar_url`, `role`, timestamps.
- Trigger `sync_profile_from_auth` keeps metadata aligned with auth payloads.
- RLS: consolidated owner policies for select/insert/update/delete (`auth.uid() = user_id`).

### `public.folder_access`

- Columns: `id`, `user_id`, `file_name`, `created_at`.
- Policies: users manage only their own rows; admin edge function rewrites grants.

### `private.profile_audit`

- Audit log for profile CRUD events populated by `log_profile_change` trigger.

### `private.admin_action_log`

- Tracks admin actions (role updates, folder changes, password resets, deletions) with JSON detail payloads.

### Storage buckets

- `avatars` (public) ‚Äî stores `<user_id>.jpg`; policies restrict CRUD to the owner.
- `user-data` (private) ‚Äî stores `<user_id>/<filename>` tree; policies enforce prefix-based ownership.

### Validation checklist

- `supabase db push` applies migrations (`supabase/migrations/*.sql`).
- Re-run SQL validation scripts after migrations to confirm RLS and triggers.
- Document audits in `docs/audit/` when schema changes ship.

---

## 3. Client entry points

| Layer   | File                                         | Responsibility                                                             |
| ------- | -------------------------------------------- | -------------------------------------------------------------------------- |
| Browser | `supabase/client.js`                         | Instantiate Supabase JS client with resolved env vars                      |
| Browser | `js/auth.js`                                 | Sign in/up, password reset, redirects                                      |
| Browser | `js/auth-guard.js`                           | Enforce session, role, folder access before revealing page                 |
| Browser | `js/admin-user-console.js`                   | Admin management UI (roles, folders, resets, delete)                       |
| Browser | `js/dashboard.js`                            | Member dashboard storage/profile interactions                              |
| Edge    | `supabase/functions/secure-storage/index.ts` | Authenticated storage uploads                                              |
| Edge    | `supabase/functions/admin-users/index.ts`    | Admin API for listing users, role changes, folder access, resets, deletion |

`js/supabase-helper.js` exposes a safe accessor that disables buttons and shows messaging when credentials are missing. `js/supabase-logger.js` captures API traffic and reveals an overlay via Konami code or tapping the brand mark.

---

## 4. Access control model

1. `enforceAuthGuard` (from `js/auth-guard.js`) checks session ‚Üí role ‚Üí folder access. It dispatches:
   - `auth:ready` with `{ supabase, user, role, folderAccess }`
   - `auth:denied` with `{ reason, role?, folderAccess? }`
2. Folder IDs originate from `js/folder-catalog.js`: `components`, `style-classes`, `image-index`, `components/book-details`, `press-kit`.
3. Elevated roles (`developer`, `admin`) bypass folder requirements automatically.
4. Guard redirects unauthorized users to `login.html?redirect=<path>`.
5. Set `requireElevated: true` or `allowedRoles: ['admin']` for admin-only routes.

### Example usage

```html
<script type="module">
  import { enforceAuthGuard } from './js/auth-guard.js'
  enforceAuthGuard({
    allowedRoles: ['developer', 'admin'],
    requiredFolders: ['components'],
    loadFolderAccess: true,
  })
</script>
```

---

## 5. Admin user management console

**Frontend:** `admin-user-management.html` + `js/admin-user-console.js`

- Requires admin role via `enforceAuthGuard`.
- Lists users with email, name, role, folder grants, timestamps.
- Supports search/filter, role selection, folder toggles, password reset link generation, and account deletion (with storage cleanup).
- Toast messaging via `js/ui.js`; actions persist in `private.admin_action_log`.

**Edge API:** `supabase/functions/admin-users/index.ts`

- Validates admin status before processing.
- Routes:
  - `GET` ‚Üí `{ users, folders }`
  - `POST action="update-role"`
  - `POST action="set-folder-access"`
  - `POST action="send-password-reset"`
  - `POST action="delete-user"`
- Cleans up storage (`avatars`, `user-data`) and folder grants before deleting the auth user.

Deploy with `supabase functions deploy admin-users`. `npm run deploy:supabase` now runs `supabase secrets set --env-file ‚Ä¶` ahead of every function deploy so `SUPABASE_URL`, `SUPABASE_SERVICE_ROLE_KEY`, the anon key, and optional JWT secrets reach the edge runtime automatically.

---

## 6. Secure storage uploads

`supabase/functions/secure-storage/index.ts` handles authenticated uploads:

- Expects `bucket`, `path`, and streaming `file` body.
- Stores files under `<user.id>/<filename>`.
- Returns JSON payload with stored path; rejects missing parameters or unauthorized users.

Frontend usage lives in `js/dashboard.js` when members upload assets.

---

## 7. Bootstrap an admin account

Run locally (service role key required):

```bash
export SUPABASE_DATABASE_URL="https://<project>.supabase.co"
export SUPABASE_SERVICE_ROLE_KEY="<service-role-key>"
node scripts/bootstrap-admin.js --email you@example.com --name "Admin User"
```

- Creates or updates the user, confirms the account, sets `app_metadata.user_metadata.role = 'admin'`.
- Upserts `public.profiles` by `user_id` to mirror auth metadata without conflicting with the identity primary key.
- Prints generated password if none supplied; rotate via Supabase dashboard afterwards.

### üìá Current seeded admin (QA)

| Email                    | Password         | First name | Last name | Notes                                                   |
| ------------------------ | ---------------- | ---------- | --------- | ------------------------------------------------------- |
| `Daren.Prince@gmail.com` | `NorthStar!4829` | Daren      | Prince    | Dummy QA credential ‚Äî rotate immediately in production. |

Reference payload: [`supabase/admin-users.seed.json`](../../supabase/admin-users.seed.json).

---

## 8. Testing & observability

- `npm test` ‚Äî Vitest coverage for env resolver, auth guard, storage helpers, Netlify rules.
- `js/supabase-logger.js` overlay ‚Äî inspect API calls, network errors, and stored logs (Konami code or rapid brand taps).
- Supabase dashboard ‚Äî monitor edge function logs and storage operations.

---

## 9. Roadmap considerations

- Expand Vitest mocks for `enforceAuthGuard` events.
- Add invite/invite-resend flows once Supabase exposes APIs.
- Stream `private.admin_action_log` to long-term analytics if compliance requires.
- Review `member/` prototypes and gate them with the auth guard before linking publicly.

Stay disciplined‚Äîenv hygiene and audit trails keep the stack reliable.
